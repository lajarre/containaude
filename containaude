#!/usr/bin/env bash
set -euo pipefail

# containaude — Run Claude Code inside a Docker sandbox.
#
# Usage:
#   containaude [options] <project-path> [message]
#
# Modes:
#   --resume <id>  Resume an existing session by UUID.
#   --fresh        Start a new session (default).
#   --headless     Print output instead of TUI (works with --fresh and --resume).
#   --debug        Drop into a shell instead of launching Claude.
#
# Arguments:
#   project-path   Path to the project directory.
#   message        Optional message sent to the session.
#
# What it does:
#   - Extracts Claude OAuth credentials from macOS Keychain (never on disk)
#   - Copies ~/.claude (skills, settings) read-only into the container
#   - Mounts the session directory read-write so sessions persist to host
#   - Mounts the project at its original macOS path (Claude derives the
#     session storage key from cwd — paths must match)
#   - Only the project dir and session data are visible — no ~/.ssh, etc.
#
# Security caveats:
#   - Credentials are briefly visible via `docker inspect` on the running
#     container (env var). Acceptable for local single-user use; do NOT
#     use on shared machines or in CI without switching to Docker secrets.
#   - The project directory is mounted read-write. The agent can modify
#     your source code. Use git to review changes after the run.
#
# Prerequisites:
#   docker build -t containaude .

usage() {
  cat <<'EOF'
Usage:
  containaude [options] <project-path> [message]

Options:
  --fresh                Start a new session (default)
  --resume <session-id>  Resume a specific session
  --headless             Print output instead of TUI
  --debug                Open a shell in the container
  -h, --help             Show this help
EOF
}

# --- Parse flags ---
MODE="fresh"
DEBUG=false
HEADLESS=false
SESSION_ID=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --resume)
      MODE="resume"
      if [[ $# -lt 2 ]]; then
        echo "Error: --resume requires a session ID." >&2
        usage >&2
        exit 1
      fi
      SESSION_ID="$2"
      if [[ ! "$SESSION_ID" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        echo "Error: Invalid session ID format." >&2
        exit 1
      fi
      shift 2
      ;;
    --fresh)
      MODE="fresh"
      shift
      ;;
    --headless)
      HEADLESS=true
      shift
      ;;
    --debug)
      DEBUG=true
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      break
      ;;
    -*)
      echo "Unknown flag: $1" >&2
      usage >&2
      exit 1
      ;;
    *)
      break
      ;;
  esac
done

if [ $# -lt 1 ]; then
  usage >&2
  exit 1
fi

if [ $# -gt 2 ]; then
  echo "Error: too many positional arguments." >&2
  usage >&2
  exit 1
fi

PROJECT_PATH="$1"
MESSAGE="${2:-}"

# Resolve to absolute path
if ! PROJECT_PATH="$(cd "$PROJECT_PATH" 2>/dev/null && pwd)"; then
  echo "Error: project path does not exist or is not accessible: $PROJECT_PATH" >&2
  exit 1
fi

# Compute the path-encoded project key (Claude's convention: / -> -)
PROJECT_KEY="$(printf '%s' "$PROJECT_PATH" | tr '/' '-')"

if ! command -v docker >/dev/null 2>&1; then
  echo "Error: docker not found in PATH." >&2
  exit 1
fi

if ! command -v security >/dev/null 2>&1; then
  echo "Error: macOS security CLI not found. containaude currently supports macOS host auth only." >&2
  exit 1
fi

if [ ! -d "$HOME/.claude" ]; then
  echo "Error: ~/.claude not found. Run 'claude login' first on the host." >&2
  exit 1
fi

# Check image exists
if ! docker image inspect containaude >/dev/null 2>&1; then
  echo "Error: containaude image not found. Build it first:" >&2
  echo "  docker build -t containaude ." >&2
  exit 1
fi

# Extract credentials from macOS Keychain (never touches disk)
CREDS="$(security find-generic-password -s "Claude Code-credentials" -w 2>/dev/null)" || {
  echo "Error: Could not extract Claude credentials from Keychain." >&2
  echo "Make sure you're logged in to Claude Code on this machine." >&2
  exit 1
}
if [ -z "$CREDS" ]; then
  echo "Error: extracted Claude credentials are empty." >&2
  echo "Run 'claude login' and try again." >&2
  exit 1
fi

# Ensure the session directory exists on host (for r/w mount)
mkdir -p "$HOME/.claude/projects/$PROJECT_KEY"

echo "Note: credentials are visible via 'docker inspect' while the container is running." >&2
echo "      Project at $PROJECT_PATH is mounted read-write. Review changes with git after." >&2
echo "      Mode: $MODE $([ "$DEBUG" = true ] && echo '(debug)')" >&2
echo "" >&2

# --- Environment preamble injected into fresh sessions ---
ENV_PREAMBLE="You are running inside a Linux Docker container (not macOS).
Environment: Node 22 via system install. No mise, no Homebrew, no macOS tools.
The project is mounted at its original macOS path for session compatibility.
Only the project directory is accessible — no ~/.ssh, ~/Documents, or other host files."

# --- Build container command ---
# shellcheck disable=SC2016
SETUP='
  cp -r /host-claude/. /root/.claude/ 2>/dev/null || true
  cp /host-claude.json /root/.claude.json 2>/dev/null || true
  printf "%s" "$CLAUDE_CREDS" > /root/.claude/.credentials.json
  unset CLAUDE_CREDS
'

CLAUDE_MESSAGE=""

if [ "$DEBUG" = true ]; then
  CONTAINER_CMD="${SETUP}
    echo \"=== Debug shell (cwd: \$(pwd)) ===\"
    echo \"\"
    echo \"  claude --resume              # session picker\"
    [ -n \"\$CLAUDE_SESSION_ID\" ] && echo \"  claude --resume \$CLAUDE_SESSION_ID\"
    echo \"  claude                       # new session\"
    echo \"\"
    exec sh
  "
elif [ "$MODE" = "resume" ]; then
  CLAUDE_MESSAGE="${MESSAGE:-Continue.}"
  if [ "$HEADLESS" = true ]; then
    CONTAINER_CMD="${SETUP}
      exec claude --resume \"\$CLAUDE_SESSION_ID\" --print --verbose \"\$CLAUDE_MESSAGE\"
    "
  else
    CONTAINER_CMD="${SETUP}
      exec claude --resume \"\$CLAUDE_SESSION_ID\" \"\$CLAUDE_MESSAGE\"
    "
  fi
else
  # Fresh: build a context-aware initial message
  if [ -z "$MESSAGE" ]; then
    CLAUDE_MESSAGE="${ENV_PREAMBLE}"
  else
    CLAUDE_MESSAGE="${ENV_PREAMBLE}

${MESSAGE}"
  fi
  if [ "$HEADLESS" = true ]; then
    CONTAINER_CMD="${SETUP}
      exec claude --print --verbose \"\$CLAUDE_MESSAGE\"
    "
  else
    CONTAINER_CMD="${SETUP}
      exec claude \"\$CLAUDE_MESSAGE\"
    "
  fi
fi

# --- Run ---
DOCKER_FLAGS=(--rm)
if [ "$DEBUG" = true ] || [ "$HEADLESS" = false ]; then
  DOCKER_FLAGS+=(-it)
else
  DOCKER_FLAGS+=(-i)
fi

DOCKER_ARGS=(
  "${DOCKER_FLAGS[@]}"
  --entrypoint sh
  -e "CLAUDE_CREDS=$CREDS"
  -e "CLAUDE_SESSION_ID=$SESSION_ID"
  -e "CLAUDE_MESSAGE=$CLAUDE_MESSAGE"
  -v "$HOME/.claude:/host-claude:ro"
)

if [ -f "$HOME/.claude.json" ]; then
  DOCKER_ARGS+=( -v "$HOME/.claude.json:/host-claude.json:ro" )
else
  echo "Note: ~/.claude.json not found; continuing without host config file mount." >&2
fi

DOCKER_ARGS+=(
  -v "$HOME/.claude/projects/$PROJECT_KEY:/root/.claude/projects/$PROJECT_KEY"
  -v "$PROJECT_PATH:$PROJECT_PATH"
  -w "$PROJECT_PATH"
  containaude
  -c "$CONTAINER_CMD"
)

docker run "${DOCKER_ARGS[@]}"
